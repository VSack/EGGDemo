<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
    <head>  
        <title>RainbowUnicornsVsAliens</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, width=device-width" />

        <script>

function getPixelOffsetFromScroll(scroll, mapSize) {
	var returnVector = function () {  return {  x: null,  y: null  };  };
	
	var leftGap = Math.min(0, scroll.x * mapSize.x * blockSize - width/2 + blockSize/2);
	var rightGap = (-1) * Math.min(0, mapSize.x * blockSize - scroll.x * mapSize.x * blockSize - width/2 + blockSize/2);

	var lowerGap = Math.min(0, (1-scroll.y) * mapSize.y * blockSize - height/2 + blockSize);
	var upperGap = (-1) * Math.min(0, mapSize.y * blockSize - (1-scroll.y) * mapSize.y * blockSize - height/2);

	returnVector.x = leftGap;
	returnVector.y = lowerGap;

	if(rightGap != 0)
		returnVector.x = rightGap;
	if(upperGap != 0)
		returnVector.y = upperGap;

	if(leftGap != 0 && rightGap != 0)
		returnVector.x = 0;
	if(lowerGap != 0 && upperGap != 0)
		returnVector.y = 0;

	if(mapSize.y * blockSize < height) {
		returnVector.y = lowerGap;
	}
	if(mapSize.x * blockSize < width) {
		returnVector.x = width/2 - mapSize.x * blockSize / 2 + leftGap;
	}
	
//	if(Math.round(Math.random() * 1000) == 1) {
//		console.log("leftGap", leftGap);
//		console.log("rightGap", rightGap);
//		console.log("sum", leftGap+rightGap);
//		console.log("--------------------");
//	}
	
	return returnVector;
}









function hexToRgbA(hex, opacity){
    var c;
    if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
        c= hex.substring(1).split('');
        if(c.length== 3){
            c= [c[0], c[0], c[1], c[1], c[2], c[2]];
        }
        c= '0x'+c.join('');
        return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+','+opacity+')';
    }
    throw new Error('Bad Hex');
}







function Block() {
	this.images = [];
	this.position = function () {  return {  x: null,  y: null  };  }
	this.position.x;
	this.position.y;
	
	this.currentImageIndex = 0;
	this.lastAnimationChange = 0;
	
	this.animationSpeed = 0;
	this.isSolid = true;
}





Block.prototype.addImage = function(imageURL) {
	var image = new Image();
	image.src = imageURL;
	
	this.images.push(image);
}

Block.prototype.draw = function(scroll, mapSize) {
    if(this.images.length > 1 && this.animationSpeed > 0)
	   this.switchAnimationIndex();
    
	var x = this.position.x * blockSize;
	var y = height - this.position.y * blockSize;

	x -= scroll.x * mapSize.x * blockSize - width/2 + blockSize/2;
	y -= height/2 - (1-scroll.y) * mapSize.y * blockSize;
	
	var offSet = getPixelOffsetFromScroll(scroll, mapSize);
	
	x += offSet.x;
	y -= offSet.y;
	ctx.drawImage(this.images[this.currentImageIndex], x, y, blockSize, blockSize);
}

Block.prototype.switchAnimationIndex = function() {
	var timePassed = (new Date()).getTime() - this.lastAnimationChange;
	
	if(timePassed > this.animationSpeed) {
		this.currentImageIndex ++;
        if(this.currentImageIndex >= this.images.length)
            this.currentImageIndex = 0;
		
		this.lastAnimationChange = (new Date()).getTime();
	}
}

Block.prototype.getCenter = function() {
	var x = this.position.x * blockSize;
	var y = height - blockSize - this.position.y * blockSize;

	x += blockSize / 2;
	y += blockSize / 2;
	
	var returnVector = function () {  return {  x: null,  y: null  };  }
	returnVector.x = x;
	returnVector.y = y;
	
	return returnVector;
}







ExitGate.prototype = new Block();

function ExitGate(newPageKey, x, y) {
	this.position.x = x;
	this.position.y = y;
	
	this.newPageKey = newPageKey;
}







FinishBlock.prototype = new Block();

function FinishBlock(x, y) {
	this.position.x = x;
	this.position.y = y;
	
	this.newPageKey = "FINISHBLOCK";
    
    this.isSolid = false;
}







function Character() {
	this.positionX = null;
	this.positionY = null;
	this.collisionBoxX = null;
    this.collisionBoxY = null;
	
	this.idleImages = [];
	this.attackImages = [];
	this.runImages = [];
	this.jumpImages = [];
	
	this.animationSpeed = 300;
	this.life = 100;
    this.strength = 10;
	this.speed = 5;
	this.jumpPower = 50;
    this.showCollisionBox = false;
	
	this.lookingright = true;
	this.fallingState = 0;
	this.jumpingState = 0;
    
    this.currentImage = null;
	this.currentImageIndex = 0;
	this.lastAnimationChange = 0;
	this.lastDamageDealt = 0;
    
    this.movable = false;
}




Character.prototype.addIdleImage = function(imageURL) {
	var image = new Image();
	image.src = imageURL;
    
	this.idleImages.push(image);
}

Character.prototype.addAttackImage = function(imageURL) {
	var image = new Image();
	image.src = imageURL;
	
	this.attackImages.push(image);
}

Character.prototype.addRunImage = function(imageURL) {
	var image = new Image();
	image.src = imageURL;
	
	this.runImages.push(image);
}

Character.prototype.addJumpImage = function(imageURL) {
	var image = new Image();
	image.src = imageURL;
	
	this.jumpImages.push(image);
}

Character.prototype.setCollisionBox = function(x, y) {
	this.collisionBoxX = x;
	this.collisionBoxY = y;
}


Character.prototype.getCenter = function() {
  if(this.currentImage == null)
    this.currentImage = this.idleImages[0];
  
  var x = this.positionX * blockSize;
  var y = height - blockSize - this.positionY * blockSize;

  x += blockSize / 2;
  
  var returnVector = function () {  return {  x: null,  y: null  };  };
  returnVector.x = x;
  returnVector.y = y;
  
  return returnVector;
}

Character.prototype.displaceByPixels = function(x, y) {
	this.positionX += x / blockSize;
	this.positionY += y / blockSize;
}

Character.prototype.dealDamage = function(damage) {
    var timePassed = (new Date()).getTime() - this.lastDamageDealt;
	
	if(timePassed > 1000) {
        this.life -= damage;
        this.jump(0.5);
		
		this.lastDamageDealt = (new Date()).getTime();
	}
}
















// RENDERING


Character.prototype.switchAnimationIndex = function() {
	var timePassed = (new Date()).getTime() - this.lastAnimationChange;
	
	if(timePassed > this.animationSpeed) {
		this.currentImageIndex ++;
        this.jum
		
		this.lastAnimationChange = (new Date()).getTime();
	}
}
























// MOVEMENT

Character.prototype.getIntendedMove = function(blocks, gravity, exitGates) {
    // Implemented in inheriting classes
}


Character.prototype.move = function(blocks, gravity) {
	var intendedMove = this.getIntendedMove(blocks, gravity);
	
	intendedMove.y += Math.pow((10 / 1000) * this.jumpingState, 2);
	intendedMove.y -= Math.min(Math.pow((1 / gravity) * this.fallingState, 2), 0.2);
	
	this.fallingState++;
	this.jumpingState = Math.max(this.jumpingState-1, 0);
	
	var steps = this.speed;
	var stopMovementX = false;
	var stopMovementY = false;
	
	for(var i=0; i<steps; i++) {
		if(!stopMovementY) {
			this.positionY += (1/steps) * intendedMove.y;
			
			if(this.collisionWithBlocks(blocks)) {
				if(intendedMove.y < 0) {
					this.fallingState = 0;
				}
				this.jumpingState = 0;
				this.positionY -= (1/steps) * intendedMove.y;
				stopMovementY = true;
			}
		}

		if(!stopMovementX) {
			this.positionX += (1/steps) * intendedMove.x;
			
			if(this.collisionWithBlocks(blocks)) {
				this.positionX -= (1/steps) * intendedMove.x;
				stopMovementX = true;
			}
		}
	}
	
	// Check whether the character fell to death
	if(this.positionY < -2)
		this.life = 0;
	
	// Switch Images to characters current state
	if(this.fallingState > 5) {
		if(this.currentImageIndex >= this.jumpImages.length)
			this.currentImageIndex = 0;
		this.currentImage = this.jumpImages[this.currentImageIndex];
	}
    else if(intendedMove.x == 0) {
        if(this.currentImageIndex >= this.idleImages.length)
			this.currentImageIndex = 0;
		this.currentImage = this.idleImages[this.currentImageIndex];
    }
	/*else if(!keyDownArray.includes(37) && !keyDownArray.includes(39) && !keyDownArray.includes(38)) {
		if(this.currentImageIndex >= this.idleImages.length)
			this.currentImageIndex = 0;
		this.currentImage = this.idleImages[this.currentImageIndex];
	}*/
}



Character.prototype.collisionWithBlocks = function(blocks) {
	for(var i=0; i<blocks.length; i++) {
		if(!blocks[i].isSolid)
			continue;
		
		if(blocks[i].getCenter().x-blockSize/2 < this.getCenter().x+this.collisionBoxX/2) {
			// hinter linker Kante
			if(blocks[i].getCenter().x+blockSize/2 > this.getCenter().x-this.collisionBoxX/2) {
				// vor rechter Kante
				if(blocks[i].getCenter().y-blockSize/2 < this.getCenter().y+this.collisionBoxY/2) {
					// unter oberer Kante
					if(blocks[i].getCenter().y+blockSize/2 > this.getCenter().y-this.collisionBoxY/2) {
						// Ã¼ber unterer Kante
						
						// COLLISION
						return true;
					}
				}
			}
		}
	}
	
	return false;
}



Character.prototype.moveLeft = function(intendedMove) {
	if(this.currentImageIndex >= this.runImages.length)
		this.currentImageIndex = 0;
	this.currentImage = this.runImages[this.currentImageIndex];
	
	this.lookingright = false;
	intendedMove.x -= this.speed / blockSize;
	
	return intendedMove;
}

Character.prototype.moveRight = function(intendedMove) {
	if(this.currentImageIndex >= this.runImages.length)
		this.currentImageIndex = 0;
	this.currentImage = this.runImages[this.currentImageIndex];
	
	this.lookingright = true;
	intendedMove.x += this.speed / blockSize;
	
	return intendedMove;
}

Character.prototype.jump = function(jumpHeight) {
	if(this.fallingState <= 5) {
		this.jumpingState = this.jumpPower * jumpHeight;
	}
}







EnemyCharacter.prototype = new Character();

function EnemyCharacter() {
    this.movable = false;
    
    this.currentMove = 0;
    
    this.idleImages = [];
	this.attackImages = [];
	this.runImages = [];
	this.jumpImages = [];
}








EnemyCharacter.prototype.draw = function(scroll, mapSize) {
	if(this.currentImage == null)
		this.currentImage = this.idleImages[0];
	
	this.switchAnimationIndex();
    
	var imageX = this.positionX * blockSize;
	var imageY = height - this.positionY * blockSize;

	imageX -= scroll.x * mapSize.x * blockSize - width/2 + blockSize/2;
	imageY -= height/2 - (1-scroll.y) * mapSize.y * blockSize;
	
	var offSet = getPixelOffsetFromScroll(scroll, mapSize);
	
	imageX += offSet.x;
	imageY -= offSet.y;
    
    imageY -= this.currentImage.height/2;

	if(this.lookingright) {
		ctx.drawImage(this.currentImage, imageX, imageY);
	}
	else {
		for(var x = 0; x < this.currentImage.width; x++) {
			ctx.drawImage(this.currentImage, x, 0, 1, this.currentImage.height, this.currentImage.width - x + imageX, imageY, 1, this.currentImage.height);
		}
	}
    
    // draw Collision Box
    if(this.showCollisionBox) {
        ctx.fillStyle = "rgba(255, 100, 100, 0.5)";
        ctx.fillRect(imageX + this.currentImage.width / 2 - this.collisionBoxX / 2, imageY + this.currentImage.height / 2 - this.collisionBoxY / 2, this.collisionBoxX, this.collisionBoxY);
    }
}



EnemyCharacter.prototype.getIntendedMove = function(blocks, gravity) {
    var intendedMove = function () {  return {  x: 0,  y: 0  };  };
	intendedMove.x = 0;
	intendedMove.y = 0;
	
    if(this.currentMove == 0) {
        if(Math.random() * 100 < 1) {
            this.currentMove = Math.round((Math.random() - 0.5) * 150);
        }
    }
    else if(this.currentMove > 0) {
        this.moveRight(intendedMove);
        this.currentMove --;
    }
    else if(this.currentMove < 0) {
        this.moveLeft(intendedMove);
        this.currentMove ++;
    }
    
    if(Math.random() * 100 < 0.5)
        this.jump(Math.random());
    
    return intendedMove;
}


















HeroCharacter.prototype = new Character();

function HeroCharacter() {
    this.movable = true;
    
    this.idleImages = [];
	this.attackImages = [];
	this.runImages = [];
	this.jumpImages = [];
}





HeroCharacter.prototype.draw = function(scroll, mapSize) {
	if(this.currentImage == null)
		this.currentImage = this.idleImages[0];
	
	this.switchAnimationIndex();

	var imageX = width/2 - this.currentImage.width / 2;
	var imageY = height/2 - this.currentImage.height / 2;

	var offSet = getPixelOffsetFromScroll(scroll, mapSize);

	imageX += offSet.x;
	imageY -= offSet.y;
    
    // This handsome bugger will only calculate the blinking of your hero when he gets damaged
    var magicBlinkNumber = Math.round((Math.sin(((1000 - Math.max(0, 1000 - ((new Date()).getTime() - this.lastDamageDealt))) / 1000) * Math.PI*10)+1)/2);
    if(this.life <= 0)
        magicBlinkNumber = 0;

    if(magicBlinkNumber === 0) {
        if(this.lookingright) {
            ctx.drawImage(this.currentImage, imageX, imageY);
        }
        else {
            for(var x = 0; x < this.currentImage.width; x++) {
                ctx.drawImage(this.currentImage, x, 0, 1, this.currentImage.height, this.currentImage.width - x + imageX, imageY, 1, this.currentImage.height);
            }
        }
    }
    
    // draw Collision Box
    if(this.showCollisionBox) {
        ctx.fillStyle = "rgba(255, 100, 100, 0.5)";
        ctx.fillRect(imageX + this.currentImage.width / 2 - this.collisionBoxX / 2, imageY + this.currentImage.height / 2 - this.collisionBoxY / 2, this.collisionBoxX, this.collisionBoxY);
    }
}





HeroCharacter.prototype.getIntendedMove = function(blocks, gravity) {
    var intendedMove = function () {  return {  x: 0,  y: 0  };  };
	intendedMove.x = 0;
	intendedMove.y = 0;
	
	if(keyDownArray.includes(37))
		intendedMove = this.moveLeft(intendedMove);
	
	if(keyDownArray.includes(39))
		intendedMove = this.moveRight(intendedMove);
	
	if(keyDownArray.includes(38))
		this.jump(1);
    
    return intendedMove;
}












HeroCharacter.prototype.collisionWithSpecialBlocks = function(specialBlocks) {
	for(var i=0; i<specialBlocks.length; i++) {
		if(specialBlocks[i].getCenter().x-blockSize/2 < this.getCenter().x+this.collisionBoxX/2) {
			// hinter linker Kante
			if(specialBlocks[i].getCenter().x+blockSize/2 > this.getCenter().x-this.collisionBoxX/2) {
				// vor rechter Kante
				if(specialBlocks[i].getCenter().y-blockSize/2 < this.getCenter().y+this.collisionBoxY/2) {
					// unter oberer Kante
					if(specialBlocks[i].getCenter().y+blockSize/2 > this.getCenter().y-this.collisionBoxY/2) {
						// Ã¼ber unterer Kante
						
						// COLLISION
						return specialBlocks[i].newPageKey;
					}
				}
			}
		}
	}
	
	return null;
}









var keyDownArray = [];


function handleKeyDownEvent(event) {
	if(!keyDownArray.includes(event.keyCode))
		keyDownArray.push(event.keyCode);
	
	passKeyEventToPages(event);
}

function handleKeyUpEvent(event) {
	var index = keyDownArray.indexOf(event.keyCode);

	if (index > -1) {
		keyDownArray.splice(index, 1);
	}
}







var canvas;
var ctx;

var width;
var height;

var blockSize;
var startPageKey;





// Setup-Methode. Wird getriggert sobald html-Inhalt geladen ist.
window.addEventListener('load', function(){
	// ODER: document einen listener auf 'DOMContentLoaded' hinzufÃ¼gen
    canvas = document.getElementById('canvas');
    ctx = canvas.getContext('2d');
    
    width = window.innerWidth;
    height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;

    window.addEventListener('keydown', handleKeyDownEvent, false);
    window.addEventListener('keyup', handleKeyUpEvent, false);

    setupPages();
    
    drawGame();
    handleTicks();
}, false);





// Funktion zum Bild darstellen
function drawGame() {
//	blockSize = Math.sin((new Date()).getTime()/10000) * 25 + 75;
	
    if(width != window.innerWidth  ||  height != window.innerHeight) {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
    }
    
	drawCurrentPage();
	
    setTimeout(drawGame, 0);
}




function handleTicks() {
	var timeMessureStart = (new Date()).getTime();
	
	passTickToCurrentPage();
	
	var timeMessureEnd = (new Date()).getTime();
	var timeMessureDifference = timeMessureEnd - timeMessureStart;
	var tps = 1000 / 50;
	var timeOut = Math.max(0, tps - timeMessureDifference);
	
    setTimeout(handleTicks, timeOut);
}







function DisplayPage() {
	this.pageKey;
	this.backgroundImage;
	this.backgroundColor = "#000";
    
	this.textSize = 15;
	this.textStyle = "#fff";
}



DisplayPage.prototype.setPageKey = function(pageKey) {
	this.pageKey = pageKey;
}

DisplayPage.prototype.getPageKey = function(pageKey) {
	return this.pageKey;
}



DisplayPage.prototype.setBackgroundImage = function(imageURL) {
	this.backgroundImage = new Image();
	this.backgroundImage.src = imageURL;
}

DisplayPage.prototype.setBackgroundColor = function(colorString) {
	this.backgroundColor = colorString;
}

DisplayPage.prototype.drawBackground = function drawBackground(xPercent, yPercent) {
	ctx.fillStyle = this.backgroundColor;
	ctx.fillRect(0, 0, width, height);
    
    if(this.backgroundImage == null)
        return;
    
	xPercent = Math.max(Math.min(xPercent, 1), 0);
	yPercent = Math.max(Math.min(yPercent, 1), 0);
    
    var imageWidth = this.backgroundImage.width;
    var imageHeight = this.backgroundImage.height;
    
    var ratio = height / imageHeight;
    var additionalZoom = 1 - Math.max(width - this.backgroundImage.width * ratio, 0) / width;
    ratio = ratio / additionalZoom;
    
    if(Math.random() < 0.01)
        console.log(additionalZoom);
	
	var offsetX = (this.backgroundImage.width * ratio - width) * xPercent;
    var offsetY = (this.backgroundImage.height * ratio - height);
	
	ctx.drawImage(this.backgroundImage, -offsetX, -offsetY, this.backgroundImage.width * ratio, this.backgroundImage.height * ratio);
}

DisplayPage.prototype.keyPressed = function(event) {
    
}







LevelPage.prototype = new DisplayPage();

function LevelPage() {
	this.levelScroll = function () {  return {  x: null,  y: null  };  };
	this.mapSize = function () {  return {  x: null,  y: null  };  };
	this.gravity = 10;

	this.blocks = [];
	this.enemies = [];
	this.exitGates = [];
	this.finishBlocks = [];
	this.hero = null;
	this.showWinScreen = false;
    
    this.blockSize = 75;
    
	this.showDeathScreen = false;
    this.deathMessage = "GAME OVER";
    this.deathMessageParagraph = "Press \'Enter\' to return to the main menu";
    this.deathReturnPage = startPageKey;
    
	this.showWinScreen = false;
    this.winMessage = "CONGRATULIATIONS";
    this.winMessageParagraph = "You won the Game.\nPress \'Enter\' to return to the main menu";
    this.winReturnPage = startPageKey;
}

LevelPage.prototype.addBlock = function(givenBlock, x, y) {
    var newBlock = new Block();
    newBlock.images = givenBlock.images;
    newBlock.isSolid = givenBlock.isSolid;
    newBlock.animationSpeed = givenBlock.animationSpeed;
    
    newBlock.position.x = x;
    newBlock.position.y = y;
    
	this.blocks.push(newBlock);
}

LevelPage.prototype.addEnemy = function(givenEnemy, x, y) {
	var newEnemy = new EnemyCharacter();
    newEnemy.movable = givenEnemy.movable;
    
	newEnemy.positionX = x;
	newEnemy.positionY = y-1 + (givenEnemy.collisionBoxY/2) / this.blockSize;
    
	newEnemy.idleImages = givenEnemy.idleImages;
	newEnemy.attackImages = givenEnemy.attackImages;
	newEnemy.runImages = givenEnemy.runImages;
	newEnemy.jumpImages = givenEnemy.jumpImages;
	
	newEnemy.collisionBoxX = givenEnemy.collisionBoxX;
	newEnemy.collisionBoxY = givenEnemy.collisionBoxY;
	newEnemy.animationSpeed = givenEnemy.animationSpeed;
	newEnemy.life = givenEnemy.life;
	newEnemy.speed = givenEnemy.speed;
	newEnemy.jumpPower = givenEnemy.jumpPower;
    newEnemy.showCollisionBox = givenEnemy.showCollisionBox;
    
	this.enemies.push(newEnemy);
}

LevelPage.prototype.addHero = function(newHero, x, y) {
	this.hero = new HeroCharacter();
    
	this.hero.positionX = x;
	this.hero.positionY = y-1 + (newHero.collisionBoxY/2) / this.blockSize;
	
	this.hero.idleImages = newHero.idleImages;
	this.hero.attackImages = newHero.attackImages;
	this.hero.runImages = newHero.runImages;
	this.hero.jumpImages = newHero.jumpImages;
	
	this.hero.collisionBoxX = newHero.collisionBoxX;
	this.hero.collisionBoxY = newHero.collisionBoxY;
	this.hero.animationSpeed = newHero.animationSpeed;
	this.hero.life = newHero.life;
	this.hero.speed = newHero.speed;
	this.hero.jumpPower = newHero.jumpPower;
    this.hero.showCollisionBox = newHero.showCollisionBox;
}

LevelPage.prototype.addExitGate = function(newPageKey, x, y) {
	var newExitGate = new ExitGate(newPageKey, x, y);
	this.exitGates.push(newExitGate);
}

LevelPage.prototype.addFinishBlock = function(x, y) {
	var newFinishBlock = new FinishBlock(x, y);
	this.finishBlocks.push(newFinishBlock);
}

LevelPage.prototype.draw = function() {
	var offSet = getPixelOffsetFromScroll(this.levelScroll, this.mapSize);

	var newScrollX = offSet.x / (this.mapSize.x * blockSize);
	var newScrollY = offSet.y / (this.mapSize.y * blockSize);
	
	this.drawBackground(this.levelScroll.x-newScrollX, this.levelScroll.y+newScrollY);
	
	this.hero.draw(this.levelScroll, this.mapSize);
    
    for(var i=0; i<this.enemies.length; i++) {
		this.enemies[i].draw(this.levelScroll, this.mapSize);
	}
	
	for(var i=0; i<this.blocks.length; i++) {
		this.blocks[i].draw(this.levelScroll, this.mapSize);
	}
	
	if(this.showWinScreen) {
		this.drawAfterScreen(this.winMessage, this.winMessageParagraph, this.winReturnPage);
	}
	else if(this.showDeathScreen) {
		this.drawAfterScreen(this.deathMessage, this.deathMessageParagraph, this.deathReturnPage);
	}
}

LevelPage.prototype.executeTick = function() {
    if(this.showWinScreen || this.showDeathScreen)
        return;
    
	this.calculateMapSize();
	this.moveBackground();
	
	if(this.hero.life <= 0) {
		this.showDeathScreen = true;
	} else {
		this.hero.move(this.blocks, this.gravity, this.exitGates);
	}
    
    var heroX = this.hero.positionX * blockSize;
    var heroY = this.hero.positionY * blockSize;
    
    for(var i=0; i<this.enemies.length; i++) {
		if(this.enemies[i].life > 0) {
            this.enemies[i].move(this.blocks, this.gravity, this.exitGates);
            
            // Check if this enemy touches the hero!
            var enemyX = this.enemies[i].positionX * blockSize;
            var enemyY = this.enemies[i].positionY * blockSize;
            
            if(heroX + this.hero.collisionBoxX/2 > enemyX - this.enemies[i].collisionBoxX/2) {
                if(heroX - this.hero.collisionBoxX/2 < enemyX + this.enemies[i].collisionBoxX/2) {
                    // collision on X axes
                    
                    if(heroY + this.hero.collisionBoxY/2 > enemyY - this.enemies[i].collisionBoxY/2) {
                        if(heroY - this.hero.collisionBoxY/2 < enemyY + this.enemies[i].collisionBoxY/2) {
                            // COLLISION WITH ENEMY DETECTED
                            this.hero.dealDamage(this.enemies[i].strength);
                        }
                    }
                }
            }
        }
	}
    
    // Check whether the hero entered an exit gate
	var newPageKey = this.hero.collisionWithSpecialBlocks(this.exitGates);
	if(newPageKey != null) {
		switchPage(newPageKey);
	}
    
    // Check whether the hero finished the game!
    var newPageKey = this.hero.collisionWithSpecialBlocks(this.finishBlocks);
	if(newPageKey != null) {
		this.showWinScreen = true;
	}
}

LevelPage.prototype.calculateMapSize = function() {
	if(this.mapSize.x == null) {
		this.mapSize.x = 1;
		this.mapSize.y = 1;
		
		for(var i=0; i<this.blocks.length; i++) {
			if(this.blocks[i].position.x > this.mapSize.x)
				this.mapSize.x = this.blocks[i].position.x;
			
			if(this.blocks[i].position.y > this.mapSize.y)
				this.mapSize.y = this.blocks[i].position.y;
		}
	}
}

LevelPage.prototype.moveBackground = function() {
	this.levelScroll.x = this.hero.positionX / this.mapSize.x;
	this.levelScroll.y = 1 - this.hero.positionY / this.mapSize.y;
}

LevelPage.prototype.drawAfterScreen = function(message, messageParagraph, returnPage) {
	ctx.fillStyle = "rgba(0, 0, 0, 0.75)";
	ctx.fillRect(0, 0, width, height);

	ctx.fillStyle = "rgba(255, 255, 255, 0.75)";
	ctx.font = '100pt Arial';
	ctx.textAlign = "center";
	ctx.fillText(message, width/2, height/2+0);

	ctx.font = '20pt Arial';
	ctx.fillText(messageParagraph, width/2, height/2+100);
	
	if(keyDownArray.includes(13)) {
		setupPages();
		switchPage(returnPage);
	}
}















MenuPage.prototype = new DisplayPage();

function MenuPage() {
	this.logoImages = [];
	this.logoImageAnimationIndex = 0;
	this.logoAnimationSpeed;
	this.lastLogoAnimationChange = 0;
	
	this.buttons = [];
	this.buttonIndex = 0;
}

MenuPage.prototype.addLogoImage = function(imageURL) {
	var image = new Image();
	image.src = imageURL;
	
	this.logoImages.push(image);
}












MenuPage.prototype.draw = function() {
	this.drawBackground(0.5, 0.5);
	
	if(this.logoImages.length > 0) {
	   this.switchLogoAnimationIndex();
	   ctx.drawImage(this.logoImages[this.logoImageAnimationIndex], width/2 - this.logoImages[this.logoImageAnimationIndex].width/2, height/2 - this.logoImages[this.logoImageAnimationIndex].height);
    }
    
    for(var i=0; i<this.buttons.length; i++) {
        this.drawButton(this.buttons[i].text, i);
    }
}

MenuPage.prototype.switchLogoAnimationIndex = function() {
	var timePassed = (new Date()).getTime() - this.lastLogoAnimationChange;
	
	if(timePassed > this.logoAnimationSpeed) {
		this.logoImageAnimationIndex ++;
		if(this.logoImageAnimationIndex >= this.logoImages.length)
			this.logoImageAnimationIndex = 0;
		
		this.lastLogoAnimationChange = (new Date()).getTime();
	}
}

MenuPage.prototype.addButton = function(text, pageKey) {
    var newButton = function () {  return {  text: null,  pageKey: null  };  }
    newButton.text = text;
    newButton.pageKey = pageKey;
    
    this.buttons.push(newButton);
}

MenuPage.prototype.drawButton = function(text, index) {
	ctx.textAlign = "center";
	ctx.font = this.textSize+'pt Arial';
	var textWidth = ctx.measureText(text).width + this.textSize;
	var textHeight = this.textSize*2;
	
	ctx.fillStyle = hexToRgbA(this.textStyle, 0.4);
	if(this.buttonIndex == index)
		ctx.fillStyle = hexToRgbA(this.textStyle, 0.8);
	
	ctx.strokeStyle = "rgba(40,40,40, 1)";
	
	var x = width/2 - textWidth/ 2;
	var y = 50 + height/2 + index * (this.textSize * 2 + 10);
	
	ctx.fillRect(x, y, textWidth, textHeight);
	ctx.strokeRect(x, y, textWidth, textHeight);

	ctx.fillStyle = "rgba(255, 255, 255, 1)";
	ctx.fillText(text, width/2, y+this.textSize*1.5);
}











MenuPage.prototype.executeTick = function() {
}

MenuPage.prototype.keyPressed = function(event) {
	if(event.keyCode == 13)
        switchPage(this.buttons[this.buttonIndex].pageKey);
	
	if(event.keyCode == 38)
		this.buttonIndex --;
	if(event.keyCode == 40)
		this.buttonIndex ++;

	if(this.buttonIndex < 0)
		this.buttonIndex = this.buttons.length-1;
	if(this.buttonIndex >= this.buttons.length)
		this.buttonIndex = 0;
}


























var currentPage = null;
var pages; 


function setupPages() {
	// =========================================== //
	// This Method consists of EGG Generated Code. //
	// =========================================== //

	pages = [];
	
	// Block to the description with name "earth"
	var earth = new Block();
	earth.addImage("images/earth.png");
	earth.animationSpeed = 1;
	
	// Block to the description with name "grass"
	var grass = new Block();
	grass.addImage("images/grass.png");
	grass.animationSpeed = 1;
	
	// Block to the description with name "stone"
	var stone = new Block();
	stone.addImage("images/stone.png");
	stone.animationSpeed = 1;
	
	// Block to the description with name "metal"
	var metal = new Block();
	metal.addImage("images/metal.png");
	metal.animationSpeed = 1;
	
	// Block to the description with name "cable"
	var cable = new Block();
	cable.isSolid = false;
	cable.addImage("images/cable.png");
	cable.animationSpeed = 1;
	
	// Block to the description with name "cableLeft"
	var cableLeft = new Block();
	cableLeft.isSolid = false;
	cableLeft.addImage("images/cable_lh.png");
	cableLeft.animationSpeed = 1;
	
	// Block to the description with name "cableRight"
	var cableRight = new Block();
	cableRight.isSolid = false;
	cableRight.addImage("images/cable_rh.png");
	cableRight.animationSpeed = 1;
	
	// Block to the description with name "grassDeco"
	var grassDeco = new Block();
	grassDeco.isSolid = false;
	grassDeco.addImage("images/grass_deco.png");
	grassDeco.animationSpeed = 1;
	
	// Block to the description with name "earthDeco1"
	var earthDeco1 = new Block();
	earthDeco1.isSolid = false;
	earthDeco1.addImage("images/earth_deco01.png");
	earthDeco1.animationSpeed = 1;
	
	// Block to the description with name "earthDeco2"
	var earthDeco2 = new Block();
	earthDeco2.isSolid = false;
	earthDeco2.addImage("images/earth_deco02.png");
	earthDeco2.animationSpeed = 1;
	
	// Block to the description with name "earthDeco3"
	var earthDeco3 = new Block();
	earthDeco3.isSolid = false;
	earthDeco3.addImage("images/earth_deco03.png");
	earthDeco3.animationSpeed = 1;
	
	// Hero to the description with name "rainbowUnicorn"
	var rainbowUnicorn = new HeroCharacter();
	rainbowUnicorn.setCollisionBox(80, 80);
	rainbowUnicorn.showCollisionBox = true;
	rainbowUnicorn.jumpPower = 65;
	rainbowUnicorn.life = 10;
	rainbowUnicorn.speed = 7;
	rainbowUnicorn.strength = 3;
	rainbowUnicorn.addRunImage("images/hero01.png");
	rainbowUnicorn.addRunImage("images/hero02.png");
	rainbowUnicorn.addRunImage("images/hero03.png");
	rainbowUnicorn.addRunImage("images/hero04.png");
	rainbowUnicorn.addRunImage("images/hero05.png");
	rainbowUnicorn.addRunImage("images/hero06.png");
	rainbowUnicorn.addJumpImage("images/hero_jump.png");
	rainbowUnicorn.addIdleImage("images/hero_idle.png");
	// The Generator will simply take the highest refresh rate of all animation types.
	rainbowUnicorn.animationSpeed = 200;
	
	// Enemy to the description with name "slimyAlien"
	var slimyAlien = new EnemyCharacter();
	slimyAlien.setCollisionBox(50, 50);
	slimyAlien.jumpPower = 0;
	slimyAlien.life = 1;
	slimyAlien.speed = 1;
	slimyAlien.strength = 1;
	slimyAlien.addRunImage("images/slimy_alien01.png");
	slimyAlien.addRunImage("images/slimy_alien02.png");
	slimyAlien.addRunImage("images/slimy_alien03.png");
	slimyAlien.addJumpImage("images/slimy_alien01.png");
	slimyAlien.addJumpImage("images/slimy_alien02.png");
	slimyAlien.addJumpImage("images/slimy_alien03.png");
	slimyAlien.addIdleImage("images/slimy_alien01.png");
	slimyAlien.addIdleImage("images/slimy_alien02.png");
	slimyAlien.addIdleImage("images/slimy_alien03.png");
	// The Generator will simply take the highest refresh rate of all animation types.
	slimyAlien.animationSpeed = 300;
	
	// Enemy to the description with name "tentacleAlien"
	var tentacleAlien = new EnemyCharacter();
	tentacleAlien.setCollisionBox(50, 50);
	tentacleAlien.jumpPower = 0;
	tentacleAlien.life = 3;
	tentacleAlien.speed = 2;
	tentacleAlien.strength = 2;
	tentacleAlien.addRunImage("images/tentacle_alien_idle.png");
	tentacleAlien.addRunImage("images/tentacle_alien_run_01.png");
	tentacleAlien.addRunImage("images/tentacle_alien_run_02.png");
	tentacleAlien.addRunImage("images/tentacle_alien_run_03.png");
	tentacleAlien.addRunImage("images/tentacle_alien_run_04.png");
	tentacleAlien.addJumpImage("images/tentacle_alien_idle.png");
	tentacleAlien.addJumpImage("images/tentacle_alien_run_01.png");
	tentacleAlien.addJumpImage("images/tentacle_alien_run_02.png");
	tentacleAlien.addJumpImage("images/tentacle_alien_run_03.png");
	tentacleAlien.addJumpImage("images/tentacle_alien_run_04.png");
	tentacleAlien.addIdleImage("images/tentacle_alien_idle.png");
	// The Generator will simply take the highest refresh rate of all animation types.
	tentacleAlien.animationSpeed = 200;
	
	// Text Page to the description with name "gametitle"
	var gametitle = new TextPage();
	gametitle.setPageKey("gametitle");
	startPageKey = "gametitle";
	gametitle.setBackgroundImage("images/title.png");
	gametitle.newPageKey = "main";
	pages.push(gametitle);

	// Menu Page to the description with name "main"
	var main = new MenuPage();
	main.setPageKey("main");
	main.addButton("Spiel Starten", "prologue1");
	main.addButton("Hilfe", "help");
	main.setBackgroundImage("images/background_menu.png");
	pages.push(main);

	// Text Page to the description with name "prologue1"
	var prologue1 = new TextPage();
	prologue1.setPageKey("prologue1");
	prologue1.setBackgroundImage("images/prologue.png");
	prologue1.newPageKey = "grassland";
	pages.push(prologue1);

	// Text Page to the description with name "help"
	var help = new TextPage();
	help.setPageKey("help");
	help.addParagraph("How to Save the World. For Dummys.");
	help.addParagraph("-----------------------------------------------");
	help.addParagraph(" ");
	help.addParagraph("Benutze die Pfeiltasten auf deiner Tastatur, um den Helden zu steuern.");
	help.addParagraph(" ");
	help.addParagraph("Finde deinen Weg durch die Apokalypse - aber pass auf! Es sind gefährliche Aliens unterwegs!");
	help.setBackgroundImage("images/background_menu.png");
	help.newPageKey = "main";
	pages.push(help);

	// Level "alienMothership"
	var alienMothership = new LevelPage();
	alienMothership.setPageKey("alienMothership");
	alienMothership.blockSize = 50;
	alienMothership.gravity = 10,000000;
	alienMothership.setBackgroundImage("images/alienMothership.png");
	alienMothership.addBlock(metal, 0, 0);
	alienMothership.addHero(rainbowUnicorn, 0, 1);
	alienMothership.addBlock(metal, 0, 4);
	alienMothership.addBlock(metal, 0, 9);
	alienMothership.addBlock(metal, 0, 7);
	alienMothership.addBlock(metal, 0, 6);
	alienMothership.addBlock(metal, 0, 5);
	alienMothership.addBlock(metal, 0, 10);
	alienMothership.addBlock(metal, 0, 11);
	alienMothership.addBlock(metal, 0, 8);
	alienMothership.addBlock(cableLeft, 0, 3);
	alienMothership.addBlock(metal, 0, 19);
	alienMothership.addBlock(metal, 0, 18);
	alienMothership.addBlock(metal, 0, 17);
	alienMothership.addBlock(metal, 0, 16);
	alienMothership.addBlock(metal, 0, 15);
	alienMothership.addBlock(metal, 0, 14);
	alienMothership.addBlock(metal, 0, 13);
	alienMothership.addBlock(metal, 0, 12);
	alienMothership.addBlock(metal, 0, 20);
	alienMothership.addBlock(metal, 0, 26);
	alienMothership.addBlock(metal, 0, 25);
	alienMothership.addBlock(metal, 0, 24);
	alienMothership.addBlock(metal, 0, 23);
	alienMothership.addBlock(metal, 0, 22);
	alienMothership.addBlock(metal, 0, 21);
	alienMothership.addBlock(metal, 0, 28);
	alienMothership.addBlock(metal, 0, 27);
	alienMothership.addBlock(metal, 0, 33);
	alienMothership.addBlock(metal, 0, 32);
	alienMothership.addBlock(metal, 0, 31);
	alienMothership.addBlock(metal, 0, 30);
	alienMothership.addBlock(metal, 0, 29);
	alienMothership.addBlock(metal, 0, 37);
	alienMothership.addBlock(metal, 0, 36);
	alienMothership.addBlock(metal, 0, 35);
	alienMothership.addBlock(metal, 0, 34);
	alienMothership.addBlock(metal, 1, 0);
	alienMothership.addBlock(metal, 1, 4);
	alienMothership.addBlock(metal, 1, 11);
	alienMothership.addBlock(metal, 1, 5);
	alienMothership.addBlock(cableLeft, 1, 10);
	alienMothership.addBlock(metal, 1, 13);
	alienMothership.addBlock(metal, 1, 12);
	alienMothership.addBlock(metal, 1, 19);
	alienMothership.addBlock(cableLeft, 1, 18);
	alienMothership.addBlock(metal, 1, 20);
	alienMothership.addBlock(metal, 1, 21);
	alienMothership.addBlock(metal, 1, 27);
	alienMothership.addBlock(metal, 1, 28);
	alienMothership.addBlock(metal, 1, 33);
	alienMothership.addBlock(metal, 1, 32);
	alienMothership.addBlock(cableLeft, 1, 26);
	alienMothership.addBlock(cableLeft, 1, 31);
	alienMothership.addEnemy(tentacleAlien, 1, 34);
	alienMothership.addEnemy(tentacleAlien, 1, 37);
	alienMothership.addEnemy(tentacleAlien, 1, 36);
	alienMothership.addEnemy(tentacleAlien, 1, 35);
	alienMothership.addBlock(metal, 2, 0);
	alienMothership.addBlock(metal, 2, 4);
	alienMothership.addBlock(metal, 2, 11);
	alienMothership.addBlock(metal, 2, 5);
	alienMothership.addBlock(metal, 2, 12);
	alienMothership.addBlock(metal, 2, 19);
	alienMothership.addBlock(metal, 2, 20);
	alienMothership.addBlock(metal, 2, 27);
	alienMothership.addBlock(metal, 2, 28);
	alienMothership.addBlock(metal, 2, 33);
	alienMothership.addEnemy(tentacleAlien, 2, 36);
	alienMothership.addEnemy(tentacleAlien, 2, 34);
	alienMothership.addBlock(metal, 3, 0);
	alienMothership.addBlock(metal, 3, 4);
	alienMothership.addBlock(metal, 3, 11);
	alienMothership.addBlock(metal, 3, 19);
	alienMothership.addBlock(cable, 3, 18);
	alienMothership.addBlock(metal, 3, 27);
	alienMothership.addBlock(metal, 3, 33);
	alienMothership.addBlock(cable, 3, 26);
	alienMothership.addBlock(cable, 3, 32);
	alienMothership.addBlock(cable, 3, 3);
	alienMothership.addBlock(metal, 4, 0);
	alienMothership.addBlock(metal, 4, 1);
	alienMothership.addBlock(metal, 4, 8);
	alienMothership.addBlock(metal, 4, 15);
	alienMothership.addBlock(metal, 4, 24);
	alienMothership.addBlock(cable, 4, 23);
	alienMothership.addBlock(metal, 5, 0);
	alienMothership.addBlock(metal, 5, 1);
	alienMothership.addBlock(metal, 5, 8);
	alienMothership.addBlock(metal, 5, 16);
	alienMothership.addBlock(metal, 5, 15);
	alienMothership.addBlock(cable, 5, 14);
	alienMothership.addBlock(metal, 5, 24);
	alienMothership.addBlock(metal, 5, 30);
	alienMothership.addBlock(cableRight, 5, 23);
	alienMothership.addBlock(metal, 6, 0);
	alienMothership.addBlock(metal, 6, 1);
	alienMothership.addBlock(metal, 6, 2);
	alienMothership.addBlock(metal, 6, 8);
	alienMothership.addBlock(metal, 6, 9);
	alienMothership.addBlock(metal, 6, 16);
	alienMothership.addBlock(cableLeft, 6, 15);
	alienMothership.addBlock(metal, 6, 17);
	alienMothership.addBlock(metal, 6, 24);
	alienMothership.addBlock(metal, 6, 23);
	alienMothership.addBlock(metal, 6, 25);
	alienMothership.addBlock(metal, 6, 30);
	alienMothership.addBlock(metal, 6, 36);
	alienMothership.addBlock(metal, 6, 31);
	alienMothership.addBlock(cableRight, 6, 29);
	alienMothership.addBlock(cableRight, 6, 35);
	alienMothership.addEnemy(tentacleAlien, 6, 37);
	alienMothership.addBlock(metal, 7, 0);
	alienMothership.addBlock(metal, 7, 1);
	alienMothership.addBlock(metal, 7, 2);
	alienMothership.addBlock(metal, 7, 8);
	alienMothership.addBlock(metal, 7, 9);
	alienMothership.addBlock(cable, 7, 7);
	alienMothership.addBlock(metal, 7, 16);
	alienMothership.addBlock(cableRight, 7, 15);
	alienMothership.addBlock(metal, 7, 17);
	alienMothership.addBlock(metal, 7, 18);
	alienMothership.addBlock(metal, 7, 24);
	alienMothership.addBlock(metal, 7, 23);
	alienMothership.addBlock(metal, 7, 25);
	alienMothership.addBlock(metal, 7, 30);
	alienMothership.addBlock(metal, 7, 29);
	alienMothership.addBlock(metal, 7, 36);
	alienMothership.addBlock(metal, 7, 35);
	alienMothership.addBlock(metal, 7, 31);
	alienMothership.addBlock(cable, 7, 34);
	alienMothership.addBlock(cableRight, 7, 22);
	alienMothership.addFinishBlock(7, 37);
	alienMothership.addBlock(metal, 8, 0);
	alienMothership.addBlock(metal, 8, 1);
	alienMothership.addBlock(metal, 8, 2);
	alienMothership.addBlock(metal, 8, 8);
	alienMothership.addBlock(metal, 8, 9);
	alienMothership.addBlock(cableRight, 8, 7);
	alienMothership.addBlock(metal, 8, 18);
	alienMothership.addBlock(metal, 8, 17);
	alienMothership.addBlock(metal, 8, 16);
	alienMothership.addBlock(metal, 8, 15);
	alienMothership.addBlock(metal, 8, 14);
	alienMothership.addBlock(metal, 8, 13);
	alienMothership.addBlock(metal, 8, 12);
	alienMothership.addBlock(metal, 8, 11);
	alienMothership.addBlock(metal, 8, 10);
	alienMothership.addBlock(metal, 8, 24);
	alienMothership.addBlock(metal, 8, 23);
	alienMothership.addBlock(metal, 8, 22);
	alienMothership.addBlock(metal, 8, 28);
	alienMothership.addBlock(metal, 8, 27);
	alienMothership.addBlock(metal, 8, 26);
	alienMothership.addBlock(metal, 8, 25);
	alienMothership.addBlock(cable, 8, 21);
	alienMothership.addBlock(metal, 8, 31);
	alienMothership.addBlock(metal, 8, 30);
	alienMothership.addBlock(metal, 8, 29);
	alienMothership.addBlock(metal, 8, 36);
	alienMothership.addBlock(metal, 8, 35);
	alienMothership.addBlock(metal, 8, 34);
	alienMothership.addBlock(metal, 8, 33);
	alienMothership.addBlock(metal, 8, 32);
	alienMothership.addEnemy(tentacleAlien, 8, 37);
	pages.push(alienMothership);

	
	// Level "grassland"
	var grassland = new LevelPage();
	grassland.setPageKey("grassland");
	grassland.blockSize = 50;
	grassland.gravity = 10,000000;
	grassland.setBackgroundImage("images/grassland.png");
	grassland.addBlock(earth, 8, 0);
	grassland.addBlock(earth, 8, 4);
	grassland.addBlock(grassDeco, 8, 5);
	grassland.addEnemy(slimyAlien, 8, 1);
	grassland.addBlock(earth, 9, 0);
	grassland.addBlock(earth, 9, 4);
	grassland.addBlock(grassDeco, 9, 5);
	grassland.addBlock(earth, 10, 0);
	grassland.addBlock(earth, 10, 4);
	grassland.addBlock(grassDeco, 10, 5);
	grassland.addBlock(earth, 11, 0);
	grassland.addBlock(earth, 11, 4);
	grassland.addBlock(grassDeco, 11, 5);
	grassland.addBlock(earth, 12, 0);
	grassland.addBlock(earth, 12, 4);
	grassland.addBlock(grassDeco, 12, 5);
	grassland.addBlock(earth, 13, 0);
	grassland.addBlock(earth, 13, 4);
	grassland.addBlock(grassDeco, 13, 5);
	grassland.addBlock(earth, 14, 0);
	grassland.addBlock(earth, 14, 4);
	grassland.addBlock(grassDeco, 14, 5);
	grassland.addBlock(grassDeco, 14, 1);
	grassland.addBlock(earth, 15, 0);
	grassland.addBlock(grassDeco, 15, 1);
	grassland.addBlock(earth, 16, 0);
	grassland.addBlock(grassDeco, 16, 1);
	grassland.addBlock(earth, 17, 0);
	grassland.addBlock(grassDeco, 17, 1);
	grassland.addBlock(earth, 18, 0);
	grassland.addBlock(grassDeco, 18, 1);
	grassland.addBlock(earth, 0, 0);
	grassland.addHero(rainbowUnicorn, 0, 2);
	grassland.addBlock(grassDeco, 0, 1);
	grassland.addBlock(earth, 1, 0);
	grassland.addBlock(grassDeco, 1, 1);
	grassland.addBlock(earth, 2, 0);
	grassland.addBlock(earth, 2, 1);
	grassland.addBlock(grassDeco, 2, 2);
	grassland.addBlock(earth, 3, 0);
	grassland.addBlock(earth, 3, 1);
	grassland.addBlock(grassDeco, 3, 2);
	grassland.addBlock(earth, 4, 0);
	grassland.addBlock(earth, 4, 1);
	grassland.addBlock(earth, 4, 2);
	grassland.addBlock(grassDeco, 4, 3);
	grassland.addBlock(earth, 5, 0);
	grassland.addBlock(earth, 5, 1);
	grassland.addBlock(earth, 5, 2);
	grassland.addBlock(earth, 5, 3);
	grassland.addBlock(grassDeco, 5, 4);
	grassland.addBlock(earth, 6, 0);
	grassland.addBlock(earth, 6, 1);
	grassland.addBlock(earth, 6, 3);
	grassland.addBlock(earth, 6, 4);
	grassland.addBlock(grassDeco, 6, 5);
	grassland.addBlock(earth, 7, 0);
	grassland.addBlock(earth, 7, 1);
	grassland.addBlock(earth, 7, 4);
	grassland.addBlock(grassDeco, 7, 5);
	grassland.addBlock(earth, 40, 0);
	grassland.addBlock(grassDeco, 40, 1);
	grassland.addBlock(earth, 24, 0);
	grassland.addBlock(grassDeco, 24, 1);
	grassland.addBlock(earth, 25, 0);
	grassland.addBlock(grassDeco, 25, 1);
	grassland.addBlock(earth, 26, 0);
	grassland.addBlock(grassDeco, 26, 1);
	grassland.addBlock(earth, 27, 0);
	grassland.addBlock(earth, 27, 1);
	grassland.addBlock(grassDeco, 27, 2);
	grassland.addBlock(earth, 28, 0);
	grassland.addBlock(earth, 28, 1);
	grassland.addBlock(grassDeco, 28, 2);
	grassland.addBlock(earth, 29, 0);
	grassland.addBlock(earth, 29, 1);
	grassland.addBlock(grassDeco, 29, 2);
	grassland.addBlock(earth, 30, 0);
	grassland.addBlock(earth, 30, 1);
	grassland.addBlock(earth, 30, 2);
	grassland.addBlock(grassDeco, 30, 3);
	grassland.addBlock(earth, 31, 0);
	grassland.addBlock(earth, 31, 1);
	grassland.addBlock(earth, 31, 2);
	grassland.addBlock(grassDeco, 31, 3);
	grassland.addBlock(earth, 32, 0);
	grassland.addBlock(earth, 32, 1);
	grassland.addBlock(earth, 32, 2);
	grassland.addBlock(grassDeco, 32, 3);
	grassland.addBlock(earth, 33, 0);
	grassland.addBlock(earth, 33, 1);
	grassland.addBlock(earth, 33, 2);
	grassland.addBlock(grassDeco, 33, 3);
	grassland.addBlock(earth, 34, 0);
	grassland.addBlock(earth, 34, 1);
	grassland.addBlock(earth, 34, 2);
	grassland.addBlock(grassDeco, 34, 3);
	grassland.addBlock(earth, 35, 0);
	grassland.addBlock(earth, 35, 1);
	grassland.addBlock(earth, 35, 2);
	grassland.addBlock(grassDeco, 35, 3);
	grassland.addBlock(earth, 36, 0);
	grassland.addBlock(earth, 36, 1);
	grassland.addBlock(earth, 36, 2);
	grassland.addBlock(grassDeco, 36, 3);
	grassland.addBlock(earth, 37, 0);
	grassland.addBlock(earth, 37, 1);
	grassland.addBlock(earth, 37, 2);
	grassland.addBlock(grassDeco, 37, 3);
	grassland.addBlock(earth, 38, 0);
	grassland.addBlock(earth, 38, 1);
	grassland.addBlock(grassDeco, 38, 2);
	grassland.addBlock(earth, 39, 0);
	grassland.addExitGate("wasteland", 39, 3);
	grassland.addBlock(grassDeco, 39, 1);
	pages.push(grassland);

	
	// Level "wasteland"
	var wasteland = new LevelPage();
	wasteland.setPageKey("wasteland");
	wasteland.blockSize = 50;
	wasteland.gravity = 10,000000;
	wasteland.setBackgroundImage("images/wasteland.png");
	wasteland.addBlock(earth, 0, 1);
	wasteland.addBlock(earth, 0, 2);
	wasteland.addHero(rainbowUnicorn, 0, 3);
	wasteland.addBlock(earth, 0, 0);
	wasteland.addBlock(earth, 1, 1);
	wasteland.addBlock(earthDeco1, 1, 2);
	wasteland.addBlock(earth, 1, 0);
	wasteland.addBlock(earth, 2, 1);
	wasteland.addBlock(earthDeco2, 2, 2);
	wasteland.addBlock(earth, 2, 0);
	wasteland.addBlock(earth, 4, 3);
	wasteland.addBlock(earthDeco2, 4, 4);
	wasteland.addBlock(earth, 5, 4);
	wasteland.addBlock(earth, 5, 0);
	wasteland.addBlock(earthDeco2, 5, 1);
	wasteland.addBlock(earth, 5, 3);
	wasteland.addBlock(earthDeco2, 5, 5);
	wasteland.addBlock(earth, 6, 4);
	wasteland.addBlock(earthDeco3, 6, 5);
	wasteland.addBlock(earth, 6, 0);
	wasteland.addEnemy(slimyAlien, 6, 1);
	wasteland.addBlock(earth, 7, 4);
	wasteland.addBlock(earthDeco2, 7, 5);
	wasteland.addBlock(earth, 7, 0);
	wasteland.addBlock(earthDeco3, 7, 1);
	wasteland.addBlock(earth, 8, 4);
	wasteland.addEnemy(slimyAlien, 8, 5);
	wasteland.addBlock(earth, 8, 0);
	wasteland.addBlock(earthDeco1, 8, 1);
	wasteland.addBlock(earth, 9, 4);
	wasteland.addBlock(earth, 9, 5);
	wasteland.addBlock(earthDeco1, 9, 6);
	wasteland.addBlock(earth, 9, 0);
	wasteland.addEnemy(slimyAlien, 9, 1);
	wasteland.addBlock(earth, 10, 4);
	wasteland.addBlock(earth, 10, 5);
	wasteland.addBlock(earth, 10, 0);
	wasteland.addBlock(earthDeco3, 10, 1);
	wasteland.addBlock(earthDeco3, 10, 6);
	wasteland.addBlock(earth, 11, 4);
	wasteland.addBlock(earth, 11, 5);
	wasteland.addBlock(earth, 11, 0);
	wasteland.addEnemy(slimyAlien, 11, 1);
	wasteland.addBlock(earthDeco2, 11, 6);
	wasteland.addBlock(earth, 15, 4);
	wasteland.addEnemy(slimyAlien, 15, 5);
	wasteland.addBlock(earth, 15, 0);
	wasteland.addBlock(earthDeco3, 15, 1);
	wasteland.addBlock(earth, 16, 4);
	wasteland.addBlock(earth, 16, 5);
	wasteland.addBlock(earthDeco3, 16, 6);
	wasteland.addBlock(earth, 16, 0);
	wasteland.addBlock(earthDeco1, 16, 1);
	wasteland.addBlock(earth, 17, 5);
	wasteland.addBlock(earth, 17, 0);
	wasteland.addEnemy(slimyAlien, 17, 1);
	wasteland.addBlock(stone, 17, 4);
	wasteland.addBlock(earthDeco1, 17, 6);
	wasteland.addBlock(earth, 12, 0);
	wasteland.addBlock(earthDeco2, 12, 1);
	wasteland.addBlock(earth, 13, 0);
	wasteland.addBlock(earthDeco1, 13, 1);
	wasteland.addBlock(earth, 14, 0);
	wasteland.addBlock(earthDeco2, 14, 1);
	wasteland.addBlock(earth, 18, 0);
	wasteland.addBlock(earth, 18, 5);
	wasteland.addBlock(stone, 18, 4);
	wasteland.addBlock(earthDeco3, 18, 6);
	wasteland.addBlock(earth, 19, 0);
	wasteland.addBlock(earth, 19, 5);
	wasteland.addBlock(stone, 19, 4);
	wasteland.addBlock(earthDeco3, 19, 1);
	wasteland.addBlock(earthDeco2, 19, 6);
	wasteland.addBlock(earth, 20, 0);
	wasteland.addBlock(earth, 20, 4);
	wasteland.addBlock(earthDeco1, 20, 1);
	wasteland.addBlock(earthDeco3, 20, 5);
	wasteland.addBlock(earth, 21, 0);
	wasteland.addBlock(earth, 21, 4);
	wasteland.addBlock(earthDeco3, 21, 1);
	wasteland.addBlock(earthDeco2, 21, 5);
	wasteland.addBlock(earth, 24, 1);
	wasteland.addEnemy(slimyAlien, 24, 2);
	wasteland.addBlock(earth, 25, 1);
	wasteland.addBlock(earth, 25, 2);
	wasteland.addBlock(earthDeco1, 25, 3);
	wasteland.addBlock(earth, 26, 1);
	wasteland.addBlock(earth, 26, 2);
	wasteland.addBlock(earthDeco3, 26, 3);
	wasteland.addBlock(earth, 27, 1);
	wasteland.addBlock(earth, 27, 2);
	wasteland.addBlock(earth, 27, 3);
	wasteland.addBlock(earthDeco1, 27, 4);
	wasteland.addBlock(earth, 28, 1);
	wasteland.addBlock(earth, 28, 2);
	wasteland.addBlock(earth, 28, 3);
	wasteland.addBlock(earthDeco3, 28, 4);
	wasteland.addBlock(earth, 29, 1);
	wasteland.addBlock(earth, 29, 2);
	wasteland.addBlock(earth, 29, 3);
	wasteland.addBlock(earthDeco2, 29, 4);
	wasteland.addBlock(earth, 30, 1);
	wasteland.addBlock(earth, 30, 2);
	wasteland.addEnemy(slimyAlien, 30, 3);
	wasteland.addBlock(earth, 31, 1);
	wasteland.addBlock(earthDeco1, 31, 2);
	wasteland.addBlock(earth, 32, 1);
	wasteland.addBlock(earthDeco3, 32, 2);
	wasteland.addBlock(stone, 37, 3);
	wasteland.addBlock(stone, 37, 4);
	wasteland.addExitGate("alienMothership", 37, 5);
	wasteland.addBlock(stone, 36, 3);
	wasteland.addBlock(stone, 36, 4);
	wasteland.addBlock(earthDeco3, 36, 5);
	wasteland.addBlock(stone, 35, 3);
	wasteland.addBlock(earthDeco3, 35, 4);
	pages.push(wasteland);

	
}


function drawCurrentPage() {
	if(currentPage == null) {
		switchPage(startPageKey);
	}
	
	currentPage.draw();
}


function passKeyEventToPages(event) {
    currentPage.keyPressed(event);
	/*if(currentPage.pageKey == "menu") {
		currentPage.keyPressed(event);
	}
	else if(currentPage.pageKey == "tutorial") {
		currentPage.keyPressed(event);
	}*/
}


function passTickToCurrentPage() {
	currentPage.executeTick();
}



function switchPage(pageKey) {
	for(var i=0; i<pages.length; i++) {
		if(pages[i].getPageKey() == pageKey) {
			currentPage = pages[i];
            
            if(currentPage instanceof LevelPage) {
                blockSize = currentPage.blockSize;
            }
		}
	}
}









TextPage.prototype = new DisplayPage();

function TextPage() {
	this.title = "";
	this.paragraphs = [];
	
	this.newPageKey;
	
	this.scroll = 0;
	this.lastLineCount = 0;
}

TextPage.prototype.addParagraph = function(text) {
	this.paragraphs.push(text);
}



TextPage.prototype.draw = function() {
	this.drawBackground(0.5, 0.5);

	ctx.fillStyle = this.textStyle;

	ctx.textAlign = "center";
	ctx.font = this.textSize*2+'pt Arial';
	ctx.fillText(this.title, width/2, this.textSize*2 + 50 + this.scroll);
	
	ctx.font = this.textSize+'pt Arial';
	var textBlockSize = Math.min(width-40, 800);
	var currentLineIndex = 0;
	
	for(var i=0; i<this.paragraphs.length; i++) {
		var paragraphWords = this.paragraphs[i].split(" ");
		
		var paragraphWordIndex = 0;
		while(paragraphWordIndex < paragraphWords.length) {
			var textLine = "";
			while(true) {
				var newTextLine = textLine + " " + paragraphWords[paragraphWordIndex];
				
				if(ctx.measureText(newTextLine).width > textBlockSize)
					break;
				
				textLine = newTextLine;
				paragraphWordIndex++;
				if(paragraphWordIndex >= paragraphWords.length)
					break;
			}
			
			ctx.fillText(textLine, width/2, 150 + this.textSize * 1.5 * currentLineIndex + this.scroll);
			currentLineIndex++;
		}
	}
	
	/*currentLineIndex +=4;
	ctx.font = this.textSize*2+'pt Arial';
	ctx.fillText("Press Enter to Continue", width/2, 150 + this.textSize * 1.5 * currentLineIndex + this.scroll);*/
	
	this.lastLineCount = currentLineIndex;
}

TextPage.prototype.keyPressed = function(event) {
	if(event.keyCode == 13)
		switchPage(this.newPageKey);
	
	if(150 + this.textSize * 1.5 * this.lastLineCount > height) {
		if(event.keyCode == 38)
			this.scroll += 10;
		if(event.keyCode == 40)
			this.scroll -= 10;
		
		if(this.scroll > 0)
			this.scroll = 0;
		if(this.scroll < (-1) * (200 + this.textSize * 1.5 * this.lastLineCount - height))
			this.scroll = (-1) * (200 + this.textSize * 1.5 * this.lastLineCount - height);
		
		if(this.lastLineCount == 0)
			this.scroll = 0;
	}
}

TextPage.prototype.executeTick = function() {
	
}









	</script>

        <style type="text/css">  
            html, body {
                width: 100%;
                height: 100%;
                padding: 0px;
                margin: 0px;
                background-color: rgb(0, 0, 0);
            }
            #canvas {
                padding: 0px;
                margin: 0px;
                top:0;
                left:0;
                z-index: 30;
                position: absolute;
                width: 100%;
                height: 100%;
                background-color: rgb(0, 0, 0);
            }
         </style>  
    </head>  

    <body>
        <canvas id="canvas" oncontextmenu="return false;">
            Um diese Seite korrekt sehen zu koennen wird ein halbwegs aktueller Browser benoetigt. Du hast so etwas leider nicht.
        </canvas>
    </body>
</html> 

